{
  "title": "Summarize JUnit XML (simple)",
  "description": "Parse a testsuites document produced by JUnit and total each suite for badge generation.",
  "program": [
    "LET root = msg.testsuites ?? msg.testsuite ?? {};",
    "LET suitesRaw = root.testsuite ?? root;",
    "LET suites = IF suitesRaw == NULL THEN []",
    "    ELSE IF IS_OBJECT(suitesRaw) THEN [suitesRaw]",
    "    ELSE suitesRaw;",
    "",
    "LET totals = { tests: 0, failures: 0, errors: 0, skipped: 0 };",
    "LET normalizedSuites = [];",
    "",
    "FOR suite IN suites {",
    "    IF suite != NULL THEN {",
    "        LET stats = {",
    "            name: suite[\"@name\"] ?? suite[\"@package\"] ?? \"unnamed suite\",",
    "            tests: NUMBER(suite[\"@tests\"] ?? 0),",
    "            failures: NUMBER(suite[\"@failures\"] ?? 0),",
    "            errors: NUMBER(suite[\"@errors\"] ?? 0),",
    "            skipped: NUMBER(suite[\"@skipped\"] ?? 0)",
    "        };",
    "",
    "        SET totals.tests = totals.tests + stats.tests;",
    "        SET totals.failures = totals.failures + stats.failures;",
    "        SET totals.errors = totals.errors + stats.errors;",
    "        SET totals.skipped = totals.skipped + stats.skipped;",
    "",
    "        SET normalizedSuites = APPEND(normalizedSuites, stats);",
    "    }",
    "}",
    "",
    "LET failed = totals.failures + totals.errors;",
    "LET status = IF totals.tests == 0 THEN \"error\"",
    "    ELSE IF failed == 0 THEN \"passing\"",
    "    ELSE \"failing\";",
    "",
    "OUTPUT {",
    "    status: status,",
    "    totals: totals,",
    "    suites: normalizedSuites",
    "}"
  ],
  "input": "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<testsuites name=\"All\" tests=\"12\" failures=\"1\" errors=\"0\" skipped=\"2\">\n  <testsuite name=\"api.tests.UserTest\" tests=\"5\" failures=\"1\" errors=\"0\" skipped=\"1\">\n    <testcase name=\"creates_user\" classname=\"api.tests.UserTest\" time=\"0.45\"/>\n    <testcase name=\"updates_user\" classname=\"api.tests.UserTest\" time=\"0.32\"/>\n  </testsuite>\n  <testsuite name=\"web.tests.CartTest\" tests=\"7\" failures=\"0\" errors=\"0\" skipped=\"1\">\n    <testcase name=\"adds_to_cart\" classname=\"web.tests.CartTest\" time=\"0.12\"/>\n  </testsuite>\n</testsuites>\n",
  "inputFormat": "xml"
}
