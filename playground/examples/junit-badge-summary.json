{
  "title": "Summarize JUnit XML (simple)",
  "description": "Normalize testsuite data and total each suite for badge generation.",
  "program": [
    "LET root = input.testsuites ?? input.testsuite ?? {};",
    "LET suitesRaw = root.testsuite ?? root;",
    "LET suites = IF suitesRaw == NULL THEN []",
    "    ELSE IF IS_OBJECT(suitesRaw) THEN [suitesRaw]",
    "    ELSE suitesRaw;",
    "",
    "LET totals = { tests: 0, failures: 0, errors: 0, skipped: 0 };",
    "LET normalizedSuites = [];",
    "",
    "FOR suite IN suites {",
    "    IF suite != NULL THEN {",
    "        LET stats = {",
    "            name: suite[\"@name\"] ?? suite[\"@package\"] ?? \"unnamed suite\",",
    "            tests: NUMBER(suite[\"@tests\"] ?? 0),",
    "            failures: NUMBER(suite[\"@failures\"] ?? 0),",
    "            errors: NUMBER(suite[\"@errors\"] ?? 0),",
    "            skipped: NUMBER(suite[\"@skipped\"] ?? 0)",
    "        };",
    "",
    "        SET totals.tests = totals.tests + stats.tests;",
    "        SET totals.failures = totals.failures + stats.failures;",
    "        SET totals.errors = totals.errors + stats.errors;",
    "        SET totals.skipped = totals.skipped + stats.skipped;",
    "",
    "        SET normalizedSuites = APPEND(normalizedSuites, stats);",
    "    }",
    "}",
    "",
    "LET failed = totals.failures + totals.errors;",
    "LET status = IF totals.tests == 0 THEN \"error\"",
    "    ELSE IF failed == 0 THEN \"passing\"",
    "    ELSE \"failing\";",
    "",
    "OUTPUT {",
    "    status: status,",
    "    totals: totals,",
    "    suites: normalizedSuites",
    "}"
  ],
  "input": {
    "testsuites": {
      "@name": "All",
      "@tests": 12,
      "@failures": 1,
      "@errors": 0,
      "@skipped": 2,
      "testsuite": [
        {
          "@name": "api.tests.UserTest",
          "@tests": 5,
          "@failures": 1,
          "@errors": 0,
          "@skipped": 1
        },
        {
          "@name": "web.tests.CartTest",
          "@tests": 7,
          "@failures": 0,
          "@errors": 0,
          "@skipped": 1
        }
      ]
    }
  }
}
