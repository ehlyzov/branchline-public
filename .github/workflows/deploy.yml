name: Build and Deploy to GitHub Pages

on:
  workflow_run:
    workflows: ["Release Artifacts"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: playground/package-lock.json

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Install playground dependencies
        run: npm ci
        working-directory: ./playground

      - name: Fetch benchmark summaries
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p docs/benchmarks/releases
          mkdir -p docs/benchmarks/jsonata/releases

          latest_path="docs/benchmarks/latest.md"
          index_path="docs/benchmarks/releases/index.md"
          list_path="docs/benchmarks/releases/list.md"
          jsonata_latest_path="docs/benchmarks/jsonata/latest.md"
          jsonata_index_path="docs/benchmarks/jsonata/releases/index.md"
          jsonata_list_path="docs/benchmarks/jsonata/releases/list.md"

          : > "$index_path"
          : > "$list_path"
          : > "$jsonata_index_path"
          : > "$jsonata_list_path"

          releases=$(curl -sSL -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases?per_page=100")

          latest_written=false
          jsonata_latest_written=false
          while IFS= read -r release; do
            tag=$(echo "$release" | base64 --decode | jq -r '.tag_name')
            prerelease=$(echo "$release" | base64 --decode | jq -r '.prerelease')
            asset_url=$(echo "$release" | base64 --decode | jq -r --arg tag "$tag" \
              '.assets[]? | select(.name == ("branchline-jmh-summary-" + $tag + ".md")) | .browser_download_url' \
              | head -1)

            if [[ -z "$asset_url" || "$asset_url" == "null" ]]; then
              continue
            fi

            safe_tag="${tag//\//-}"
            safe_tag="${safe_tag// /-}"
            out_path="docs/benchmarks/releases/${safe_tag}.md"
            curl -sSL -H "Authorization: Bearer $GH_TOKEN" -o "$out_path" "$asset_url"
            release_assets_dir="docs/benchmarks/releases/${safe_tag}"
            mkdir -p "$release_assets_dir"
            csv_asset_url=$(echo "$release" | base64 --decode | jq -r --arg tag "$tag" \
              '.assets[]? | select(.name == ("branchline-jmh-summary-" + $tag + ".csv")) | .browser_download_url' \
              | head -1)
            if [[ -n "$csv_asset_url" && "$csv_asset_url" != "null" ]]; then
              curl -sSL -H "Authorization: Bearer $GH_TOKEN" -o "${release_assets_dir}/jmh-summary.csv" "$csv_asset_url"
            fi

            label="$tag"
            if [[ "$prerelease" == "true" ]]; then
              label="${tag} (prerelease)"
            fi
            echo "- [${label}](${safe_tag}/)" >> "$index_path"
            echo "- [${label}](releases/${safe_tag}/)" >> "$list_path"

            if [[ "$latest_written" == "false" ]]; then
              cp "$out_path" "$latest_path"
              latest_written=true
            fi

            jsonata_asset_url=$(echo "$release" | base64 --decode | jq -r --arg tag "$tag" \
              '.assets[]? | select(.name == ("branchline-jsonata-summary-" + $tag + ".md")) | .browser_download_url' \
              | head -1)

            if [[ -n "$jsonata_asset_url" && "$jsonata_asset_url" != "null" ]]; then
              jsonata_out_path="docs/benchmarks/jsonata/releases/${safe_tag}.md"
              curl -sSL -H "Authorization: Bearer $GH_TOKEN" -o "$jsonata_out_path" "$jsonata_asset_url"
              jsonata_assets_dir="docs/benchmarks/jsonata/releases/${safe_tag}"
              mkdir -p "$jsonata_assets_dir"
              jsonata_csv_asset_url=$(echo "$release" | base64 --decode | jq -r --arg tag "$tag" \
                '.assets[]? | select(.name == ("branchline-jsonata-summary-" + $tag + ".csv")) | .browser_download_url' \
                | head -1)
              if [[ -n "$jsonata_csv_asset_url" && "$jsonata_csv_asset_url" != "null" ]]; then
                curl -sSL -H "Authorization: Bearer $GH_TOKEN" -o "${jsonata_assets_dir}/jsonata-summary.csv" "$jsonata_csv_asset_url"
              fi
              echo "- [${label}](${safe_tag}/)" >> "$jsonata_index_path"
              echo "- [${label}](releases/${safe_tag}/)" >> "$jsonata_list_path"

              if [[ "$jsonata_latest_written" == "false" ]]; then
                cp "$jsonata_out_path" "$jsonata_latest_path"
                jsonata_latest_written=true
              fi
            fi
          done < <(echo "$releases" | jq -r '.[] | select(.draft == false) | @base64')

          if [[ "$latest_written" == "false" ]]; then
            echo "_No benchmark summaries found in releases._" > "$latest_path"
            echo "_No benchmark summaries found in releases._" >> "$index_path"
            echo "_No benchmark summaries found in releases._" >> "$list_path"
          fi

          if [[ "$jsonata_latest_written" == "false" ]]; then
            echo "_No JSONata benchmark summaries found in releases._" > "$jsonata_latest_path"
            echo "_No JSONata benchmark summaries found in releases._" >> "$jsonata_index_path"
            echo "_No JSONata benchmark summaries found in releases._" >> "$jsonata_list_path"
          fi

      - name: Build interpreter for JavaScript
        run: ./gradlew :interpreter:jsBrowserProductionLibraryDistribution

      - name: Build playground assets
        run: npm run build
        working-directory: ./playground
      
      - name: Debug - Check playground build output
        run: |
          echo "Checking playground build output:"
          ls -la docs/
          if [ -d "docs/assets" ]; then
            echo "Assets directory exists:"
            ls -la docs/assets/ | head -10
          else
            echo "No docs/assets directory found after playground build"
          fi

      - name: Build documentation with MkDocs
        run: mkdocs build --site-dir site

      - name: Prepare deployment directory
        run: |
          # Create deployment structure
          mkdir -p deploy
          
          # Copy built documentation site (this includes the playground page)
          cp -r site/* deploy/
          
          # Copy playground assets to assets directory (where demo.html expects them)
          mkdir -p deploy/assets
          # The playground build puts assets in docs/assets/, copy them to deploy/assets/
          if [ -d "docs/assets" ]; then
            cp -r docs/assets/* deploy/assets/
            echo "Copied playground assets to deploy/assets/"
          else
            echo "No assets directory found"
          fi
          
          # Copy playground directory contents to deploy/playground (overwrite MkDocs placeholder)
          mkdir -p deploy/playground
          cp playground/demo.html deploy/playground/
          cp -r playground/examples deploy/playground/
          cp -r playground/src deploy/playground/
          
          echo "Deployment structure:"
          echo "Root files:"
          ls -la deploy/ | head -5
          echo "Playground files:"
          ls -la deploy/playground/
          echo "Assets:"
          ls deploy/assets/ | head -5

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './deploy'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
